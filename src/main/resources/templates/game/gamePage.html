<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" rel="stylesheet">
    <link href="/src/main/resources/static/style/own.css" rel="stylesheet">
    <script crossorigin="anonymous"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script crossorigin="anonymous"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
    <script crossorigin="anonymous"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"></script>

    <link rel="shortcut icon" th:href="@{/image/nav-icon.png}">
    <title>Speech learning</title>
    <meta th:insert="fragments/header :: header"/>
</head>
<body>
<div th:insert="fragments/navbar :: navbar">
</div>
<section class="p-4">
    <div class="container">
        <div class="card-body p-md-5">
            <div class="row">
                <div class="col-4 p-2 ">
                    <figure class="figure px-2">
                        <img alt="Image does not exist" class="figure-img img-fluid rounded"
                             height="46"
                             id="heart1" th:src="@{image/heart.png}" width="54">
                    </figure>
                    <figure class="figure px-2">
                        <img alt="Image does not exist" class="figure-img img-fluid rounded"
                             height="46"
                             id="heart2" th:src="@{image/heart.png}" width="54">
                    </figure>
                    <figure class="figure px-2">
                        <img alt="Image does not exist" class="figure-img img-fluid rounded"
                             height="46"
                             id="heart3" th:src="@{image/heart.png}" width="54">
                    </figure>
                </div>
                <div class="col-7 px-5">
                    <h1 class="display-4 text-uppercase text-lg">
                        Score <strong class="text-success" id="score">0</strong>
                    </h1>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="row p-2">
                        <div class="col-5 pt-4 ">
                            <figure class="figure px-2">
                                <img alt="Image does not exist" class="figure-img img-fluid rounded"
                                     height="285" id="knight"
                                     th:src="@{image/knight-stay.gif}" width="470" }>
                            </figure>
                        </div>
                        <div class="col-2 pt-5">
                            <h1 id="speech_target" th:text="${gameWord}"></h1>
                        </div>
                        <div class="col-5">
                            <figure class="figure px-2">
                                <img alt="Image does not exist" class="figure-img img-fluid rounded"
                                     height="720" id="monster"
                                     th:src="@{image/monster-stay.gif}" width="720" }>
                            </figure>
                        </div>
                    </div>

                    <div class="row p-2">
                        <div class="col text-center">
                            <div data-role="controls">
                                <button class="btn btn-success btn-lg" id="audio-recorder">
                                    Start recording
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row p-2">
                        <div class="col text-center">
                            <div data-role="recordings">
                                <button class="btn btn-success btn-lg" id="upload-button" onclick="uploadFile()">
                                    Verify record
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row align-items-center p-2">
                        <div class="col-3 ">
                            <h4 class="mb-0 text-success" id="success-label">
                            </h4>
                        </div>
                        <div class="col-9">
                            <p class="lead" id="recognized-success-result"></p>
                        </div>
                    </div>
                    <div class="row align-items-center p-2">
                        <div class="col-3 ">
                            <h4 class="mb-0 text-danger" id="failed-label">
                            </h4>
                        </div>
                        <div class="col-9">
                            <p class="lead" id="recognized-failed-result"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<div th:insert="fragments/footer :: footer"></div>
<div class="modal" id="exampleModal" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class=" col text-center">
                    <h5 class="modal-title">
                        Game Over <span id="finish-result">0</span>
                    </h5>
                </div>
            </div>
            <div class="modal-body">
                <div class=" col text-center">
                    <p>
                        You are a powerful knight go on.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <div class="col text-center">
                    <a class="btn btn-primary" th:href="@{/game}" type="button">
                        Restart game
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

<script src="https://markjivko.com/dist/recorder.js"></script>
<script>

    let savedAudio;
    let countFailed = 0;
    let countScore = 0;
    let successResult = document.getElementById("recognized-success-result");
    let successLabel = document.getElementById("success-label");

    /**
     * @param data.wrongText -  text that our user said wrong
     *  @param data.correctText - text that matching with our content
     *  @param data.fullText - full recognized text
     * @returns {Promise<void>}
     */
    async function uploadFile() {
        let formData = new FormData();

        formData.append('file', savedAudio, 'testRecorder.wav');
        var contentText = document.getElementById("speech_target")
        formData.append("contentText", contentText.innerText);

        await fetch('/recognize-for-game', {
            method: "POST",
            body: formData
        }).then(response =>
            response.json().then(data => ({
                    data: data,
                    status: response.status
                })
            ).then(result => {
                      if (!response.ok) {
                        successResult.textContent = 'The text was not recognized try again';
                        return;
                    }
                    let knightImage = document.getElementById("knight");

                    if (result.data.correctText.length > 0) {
                        successResult = document.getElementById("recognized-success-result");
                        successLabel = document.getElementById("success-label");

                        successResult.textContent = result.data.correctText;
                        successLabel.textContent = "Correctly pronounced text";
                        knightImage.src = "/image/knight-attack.gif"
                        setTimeout(function () {
                            knightImage.src = "/image/knight-stay.gif"
                        }, 2500);
                        countScore = countScore + 5;
                        let score = document.getElementById("score");
                        score.textContent = countScore;
                    } else {
                        let failedResult = document.getElementById("recognized-failed-result");
                        let failedLabel = document.getElementById("failed-label");
                        let monsterImage = document.getElementById("monster");

                        failedResult.textContent = result.data.wrongText;
                        failedLabel.textContent = "Incorrectly pronounced text";
                        monsterImage.src = "/image/monster-attack.gif"
                        setTimeout(function () {
                            monsterImage.src = "/image/monster-stay.gif"
                        }, 2500);
                        countFailed++;
                        let heart = document.getElementById("heart".concat(countFailed));
                        heart.parentNode.removeChild(heart);
                    }

                    if (countFailed === 3) {
                        knightImage.src = "/image/knight-death1.gif";
                        document.getElementById("finish-result").textContent = countScore;
                        $('#exampleModal').modal('toggle');
                    }
                    fetch('get-word', {
                        method: "GET"
                    }).then(response => response.text())
                        .then(response => {
                            let textForGamer = document.getElementById("speech_target");
                            textForGamer.textContent = response;
                        })
                }
            ));
    }

    jQuery(document).ready(function () {
        var $ = jQuery;
        var myRecorder = {
            objects: {
                context: null,
                stream: null,
                recorder: null
            },
            init: function () {
                if (null === myRecorder.objects.context) {
                    myRecorder.objects.context = new (
                        window.AudioContext || window.webkitAudioContext
                    );
                }
            },
            start: function () {

                var options = {audio: true, video: false};
                navigator.mediaDevices.getUserMedia(options).then(function (stream) {
                    myRecorder.objects.stream = stream;
                    myRecorder.objects.recorder = new Recorder(
                        myRecorder.objects.context.createMediaStreamSource(stream),
                        {numChannels: 1}
                    );
                    myRecorder.objects.recorder.record();
                }).catch(function (err) {
                });
            },
            stop: function (listObject) {
                if (null !== myRecorder.objects.stream) {
                    myRecorder.objects.stream.getAudioTracks()[0].stop();
                }
                if (null !== myRecorder.objects.recorder) {
                    myRecorder.objects.recorder.stop();

                    // Validate object
                    if (null !== listObject
                        && 'object' === typeof listObject
                        && listObject.length > 0) {
                        // Export the WAV file
                        myRecorder.objects.recorder.exportWAV(function (blob) {
                            var url = (window.URL || window.webkitURL)
                                .createObjectURL(blob);
                            savedAudio = blob

                            // Prepare the playback
                            var audioObject = $('<audio controls></audio>')
                                .attr('src', url);

                            // Prepare the download link
                            var downloadObject = $('<a>&#9660;</a>')
                                .attr('href', url)
                                .attr('download', new Date().toUTCString() + '.wav');

                            // Wrap everything in a row
                            var holderObject = $('<div class="row p-2"></div>')
                                .append(audioObject)
                                .append(downloadObject);

                            // Append to the list
                            listObject.append(holderObject);
                        });
                    }
                }
            }
        };
        // Prepare the recordings list
        var listObject = $('[data-role="recordings"]');

        // Prepare the record button
        $('[data-role="controls"] > button').click(function () {
            // Initialize the recorder
            myRecorder.init();

            // Get the button state
            var buttonState = !!$(this).attr('data-recording');

            // Toggle
            if (!buttonState) {
                $(this).attr('data-recording', 'true');
                $(this).removeClass('btn-success');
                $(this).addClass('btn-danger')
                $(this).text('Stop recording')
                myRecorder.start();
            } else {
                $(this).attr('data-recording', '');
                $(this).removeClass('btn-danger');
                $(this).addClass('btn-success')
                $(this).text('Start recording')
                myRecorder.stop(listObject);
            }
        });
    });

</script>